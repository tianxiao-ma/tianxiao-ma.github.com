---
title: How Data Send and Received on Internet
layout: post
permalink: /2013/04/how-data-send-and-received-on-internet/
date: Wed Apr 06 21:00:00 pm GMT+8 2013
published: true
---

本文将会讲解数据是如何在互联网上被发送和接收的，通过对TCP/IP协议、路由器的工作原理的介绍，大家就会知道数据是如何在互联网上的两个节点之间进行发送和接收的。

# 1. 数据封装
应用程序产生的数据在被发送到网络上之前会经过一些列协议的处理，TCP/IP协议族分布于传送层、网络层和链路层。为了使得数据能够正确地被传送到目标节点，数据首先需要在传送层被进行一次封装，执行传送层封装的是TCP或者UDP协议。经过TCP和UDP封装后的数据会转交给网络层网络层进行处理，网络层的主要协议是IP协议，在这一层根据IP协议的规范，数据会再一次被进行封装。之后，数据会来到链路层，在这一层，根据不同的链路层协议，数据还会被进行一次封装。最后，这些数据会交由物理层进行传送。

每一层的封装需要做的最主要工作就是为上层数据增加头部信息，例如在传送层，TCP协议回为数据添加TCP头部信息，在网络层，IP协议会为会为数据添加IP头部信息，而链路层的相关协议也需要为数据添加头部信息。

## 1.1. TCP头部信息
TCP的头部信息主要包含两部分数据，一是标记数据是来自哪个上层协议的数据，二是为了保证可靠性而添加的各种相关属性。TCP的头部格式如下图所示

![TCP Header Format](/images/2013-04//tcp-header.png)

由于本文的主要目的是讨论数据如何被传送和接收，所以TCP协议不是我们的重点，如果想详细了解TCP协议，可以参考[TCP协议规范](https://www.ietf.org/rfc/rfc793.txt)。

##  1.2. IP头部信息
IP协议的头部于数据的传送有非常密切的关系，先来看IP协议的头部格式，如下图所示：

![IP Header Format](/images/2013-04/ip-header.png)

与本文比较相关的是*Source Address*和*Destination Address*这两个部分。前者是发送数据的节点的IP地址，而后者则是接收数据的节点IP地址，这两个地址在绝大部分情况下是不会发生改变的(只有在使用[IP源路由](http://baike.baidu.com/view/2886167.htm)的时候会被修改)。完整的说明可以参考[IP协议规范](https://www.ietf.org/rfc/rfc791.txt)

## 1.3. 链路层协议头信息
链路层协议用来封装IP协议产生的数据，将数据封装成帧，因此链路层协议其实是规定了在物理线路上传送的数据帧的格式。由于链路层的协议比较多，加上与本文的关系不是很大，这里就不讨论了。总的来说，链路层的协议的头部指明了源节点的物理地址(MAC地址)和目标节点的物理地址。

链路层数据帧在传送的过程中，目标节点的物理地址是有可能发生变化，这个在后面会讲到。

# 2. 子网划分
## 2.1. IP地址类型
目前IPv4共有5类地址，5类不同的地址如下图所示：

![IP Address](/images/2013-04/ip-address.png)

从图中可以看到，没一类地址都有不同长度的网络号和主机号区域，同时也会有一些保留位用来标识一个类型的地址。通过这种方式，我们很容易从IP地址中识别其类型。另外，规定没类地址的网络号也是有现实意义的，在划分子网和IP数据路由的过程中都需要用到这个网络号。下面来看看子网划分。

## 2.2. 子网划分
划分子网的主要目的是减小路由表的记录数，其次就是更加合理地分配B类地址(B类地址的总数还是比较少的)。路由表会在后面有进一步的介绍。

由于一个B类地址可用的主机号有16位，因此一个B类地址能够构建起来的网络是非常庞大的，实际上没有企业或者机构需要这么多的主机号，通过路由器和子网划分可以让一个B类地址服务于多个企业或者机构，有效利用B类地址。

子网的划分是通过子网掩码实现的，子网掩码具有与IP地址一样的长度。子网掩码被用来区分子网号与主机号，其中全1的部分留给IP地址的网络号和子网号，全0的留给主机号。下图给出1个B类地址的两个不同的子网掩码：

![Subnet Mask](/images/2013-04/subnet-mask.png)

第一个掩码可以得到256个子网号，每个子网下面可以分配254台主机(全0和全1两个主机号是保留的)。而第二个掩码则可以有2^10个子网，每个子网下面可以有62台主机。

B类地址的前16位是固定的网络号，后面的16位可以用来分配给不同的子网和子网中的主机。一旦有了IP地址和子网掩码，路由器就可以根据IP数据的目的地址去定以下几件事情：

1. 目的IP地址是否在同一个子网上；
2. 是不是同一个网络号下的其他子网上的地址；
3. 是不是另外一个网络下的地址；

通过IP地址可以确定地址的类型(没类IP地址都有固定的范围)，从而知道网络号与子网号的分界线，而通过子网掩码，我们可以知道子网号与主机号的分界点。有了这些信息，路由器能知道它应该怎样去处理收到的IP数据包了。

# 3. IP数据包路由
在互联网上进行通信的两个节点之间可能会跨越多个不同的网络，各个网络中的路由器就负责完成互联网上不同节点之间的数据路由，使得数据能够从源节点顺利到达指定的目的节点。

每个路由器在内部维护一个路由表，路由表中的主要信息包括目的地址、下一站路由器的IP地址。

* 目的地址  
目的地址可以是一个完整的IP地址，也可以是一个网络地址。主机号不为0的标识网络地址，否则就表示一个网络地址。
* 下一站路由器地址  
表明IP数据包应该被发送到的下一个路由器的地址。这个地址还可以是与当前路由器直接相连的网络节点的地址，这个时候就表示IP数据包已经到达目的地址了。

下面看一个例子：

![Sample Network](/images/2013-04/sample-network.png)

在上面这个图中，每一个路由器都会有两个IP地址，其中一个IP地址用来作为与该路由器直接相连的所有网络节点的网关IP地址，另外一个地址则用于和其他路由器的通信。

针对这个图，我们将讨论以几个不同的场景，通过解释不同场景中IP数据包是如何从源节点发送到目标节点，我们可以对前面介绍的几个知识点有一个更直观的了解，也可以知道路由器在这个过程当中是怎么工作的。

## 3.1. 同一子网内主机间通讯
ip地址为183.61.3.123的主机想要与183.61.3.124的主机通讯，主机123的数据经由传输层到达了网络层。在网络层，数据被封装进一个IP数据包内，源地址是183.61.3.123，目标地址则是183.61.3.124。

主机123查看自己的路由表，发现数据包的目的地址不是本机，但是找到了一个默认的发送地址(也就是下一站路由器的ip地址)，就是路由器主机183.61.3.1。数据包就送主机3.123送到了主机3.1，主机3.1检查IP数据包的目的地址，发现地址不是本机，由于主机3.1被配置成具有路由功能，因此它会再检查一下子网号，发现子网号就是自己负责的这个子网。因此它就去路由表中便利相同的子网下面有没有ip地址是3.124的机器，发现确实有这个机器。之后，就把IP数据包传送到3.124主机。而主机3.124发现IP数据包的地址就是本机，所以会将数据丢给上层的协议层进行处理，最终被运行在3.124主机上的应用程序接收。

## 3.2. 不同子网下的主机通讯
ip地址为183.61.3.123的主机要与ip地址为183.61.2.123的主机进行通讯。主机3.123会发出一个IP数据包，该数据包的源ip地址是183.61.3.123而目的地址则是183.61.2.123。主机3.123发现数据包的目的地址不是本机，这个时候会把数据包丢给路由器183.61.3.1。路由器接受到数据包之后，发现目的地址不是本机，而且子网号也不是自己负责的子网，因此只能将数据包丢给默认的发送地址，也就是路由器183.63.1.1。

路由器183.63.1.1收到数据包之后，发现目的地址不是本机，但是它通过子网号知道目的ip地址所处的子网由路由器183.63.1.2负责，因此会将数据包发送给路由器183.63.1.2。路由器183.63.1.2接受到数据包之后，发现目的地址不是本机，但是子网号是自己负责的子网，因此会查看自己的路由包，看看有没有ip地址为183.63.2.123的主机。当发现主机183.63.2.123确实存在之后，就会将数据包发送给主机2.123。这样数据就从主机183.61.3.123被路由到了主机183.61.2.123。

##  3.3. 不同网络下的主机通讯
ip地址为183.61.3.123主机要与ip地址为74.125.128.103的主机进行通讯。主机183.61.3.123发出一个数据包，源地址是183.61.3.123，而目的地址则是74.125.128.103。

数据首先会被送到路由器183.61.3.1，该路由器发现目的地址既不是本机也不是自己子网内的机器，因此就把数据丢给下一站路由器183.63.1.1。路由器183.63.1.1收到数据包之后，发现目的ip地址既不是本机，而且子网号也不是认识，因此就把这个数据包丢给自己的下一站路由器183.61.15.1。路由器183.61.15.1收到数据包之后，进行一样的检查，然后发给下一站路由器，直到有一个路由器知道自己与主机74.125.128.103是直接相连的，可以将数据包送达为止。

通过上面的几个例子，我们会发现，不管是主机还是路由器，再不知道怎么处理一个IP数据包之后，都会将数据包丢给一个默认的地址，而这个地址一般来说就是下一站的路由器。另外，这里对IP数据包的路由只是做了最简单的介绍，在真实的环境中，还会涉及到IP选路、物理地址交换、数据切分、网络拥塞控制等等一系列的问题。想要更详细地了解其中的各个方面看看[*TCP/IP详解*](http://www.amazon.cn/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71-%E5%8D%8F%E8%AE%AE-W-Richard-Stevens/dp/B00116OTVS)这本书。

## 3.4. 私有地址与NAT
私有地址属于注册地址，也就是说除了在机构和组织内部使用之外，是不会开放到互联网上去的。以下列表给出了各类地址的私有地址范围。

![Privacy Address](/images/2013-04/privacy-address.png)

那么一个自由地址的主机，怎么与其他主机进行通讯呢？比如有两个局域网，都使用了私有地址，其中局域网A中的ip地址为192.168.1.123的主机想要与局域网B中的ip地址为192.168.1.123的主机进行通讯。由于两个主机的ip地址是一样的，我们在上面用到的方法是无法将数据从一个主机路由到另外一个主机的。

对于这种情况，就需要用到NAT，也就是[网络地址转换(Network Address Translation)](https://en.wikipedia.org/wiki/Network_address_translation)。这个功能是所有路由器都需要支持的。在使用中，当路由器收到一个具有私有地址的IP数据包之后，会将该数据包的源地址替换成路由器的地址，然后在内存维护一个源端口地址(在TCP数据包的头部)到私有地址的映射表。当路由器收到IP数据包的时候，会根据源端口地址找到对应私有地址，然后将数据包路由到目标机器上。